"use strict";(self.webpackChunkwebgpuaudio=self.webpackChunkwebgpuaudio||[]).push([[480],{2309:(t,e,a)=>{a.r(e),a.d(e,{assets:()=>g,contentTitle:()=>f,default:()=>A,frontMatter:()=>d,metadata:()=>b,toc:()=>p});var s=a(5893),i=a(1151),r=a(1262),n=a(7294),o=a(8281),u=a(1750),h=a(9094);class l{timeoutId=null;constructor(){this.gpuWorker=new Worker(new URL(a.p+a.u(562),a.b),{type:void 0}),this.init()}async init(){console.log("init"),this.audioContext=new AudioContext,this.sampleRate=this.audioContext.sampleRate,this.gpuWorker.addEventListener("message",(async t=>{if(console.log("chunkData in engine listener",t.data.chunkData),"chunk"===t.data.type)this.chunkData=t.data.chunkData})),this.inputQueue=await new u.Z(h.Nu,1),this.outputQueue=await new u.Z(h.Nu,1),this.atomicState=await new Int32Array(new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT)),await this.audioContext.audioWorklet.addModule(new URL(a(8663),a.b));const t=new OscillatorNode(this.audioContext),e=new AudioWorkletNode(this.audioContext,"basic-processor",{processorOptions:{inputQueue:this.inputQueue,outputQueue:this.outputQueue,atomicState:this.atomicState}});t.connect(e).connect(this.audioContext.destination),t.start(),this.gpuWorker.postMessage({type:"init",data:{inputQueue:this.inputQueue,outputQueue:this.outputQueue,atomicState:this.atomicState}})}async stop(){this.audioContext&&(await this.audioContext.suspend(),await this.audioContext.close()),this.gpuWorker&&(await this.gpuWorker.terminate(),this.gpuWorker=void 0)}}function c(){const[t,e]=n.useState(!1),[a,i]=n.useState(void 0);async function r(){a&&(await a.stop(),i(void 0))}return(0,n.useEffect)((()=>()=>{r()}),[]),(0,o.M4)({[t?"Stop Sound":"Play Sound"]:(0,o.LI)((()=>{e(!t)}))},[t]),(0,n.useEffect)((()=>{t?(console.log("playing"),async function(){void 0===a&&i(new l)}()):r()}),[t]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("ul",{children:[(0,s.jsx)("li",{children:"Web Audio is heard after passing through AudioWorklet and Worker"}),(0,s.jsx)("li",{children:"Next, the audio will be passed from the WebWorker to WebGPU and back again, before returning to the AudioWorklet and then to WebAudio."})]}),(0,s.jsx)(o.Zf,{flat:!0,oneLineLabels:!0})]})}const d={title:"Worklet/Worker Passthrough",sidebar_position:2},f=void 0,b={id:"webWorker/workletWorkerFreeQueue",title:"Worklet/Worker Passthrough",description:"",source:"@site/docs/webWorker/workletWorkerFreeQueue.mdx",sourceDirName:"webWorker",slug:"/webWorker/workletWorkerFreeQueue",permalink:"/docs/webWorker/workletWorkerFreeQueue",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Worklet/Worker Passthrough",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"WebGPU Audio WebWorker Example",permalink:"/docs/webWorker/webGpuAudioWorker"},next:{title:"WebGPU Audio WebWorker Stream",permalink:"/docs/webWorker/webGpuAudioWorkerStreaming"}},g={},p=[],k=function(){const t={div:"div",...(0,i.a)()};return(0,s.jsx)(r.Z,{fallback:(0,s.jsx)(t.div,{children:"Loading..."}),children:()=>(0,s.jsx)(c,{})})};function W(t){return(0,s.jsx)(s.Fragment,{})}function A(t={}){return(0,s.jsx)(k,{...t,children:(0,s.jsx)(W,{...t})})}},1262:(t,e,a)=>{a.d(e,{Z:()=>r});a(7294);var s=a(2389),i=a(5893);function r(t){let{children:e,fallback:a}=t;return(0,s.Z)()?(0,i.jsx)(i.Fragment,{children:e?.()}):a??null}},9094:(t,e,a)=>{a.d(e,{Nu:()=>s});const s=4096},1750:(t,e,a)=>{a.d(e,{Z:()=>i});class s{States={READ:0,WRITE:1};constructor(t,e){void 0===e&&(e=1),this.states=new Uint32Array(new SharedArrayBuffer(Object.keys(this.States).length*Uint32Array.BYTES_PER_ELEMENT)),this.bufferLength=t+1,this.channelCount=e,this.channelData=[];for(let a=0;a<e;a++)this.channelData.push(new Float32Array(new SharedArrayBuffer(this.bufferLength*Float32Array.BYTES_PER_ELEMENT)))}static fromPointers(t){const e=new s(0,0),a=new Uint32Array(t.memory.buffer),i=new Float32Array(t.memory.buffer),r=a[t.bufferLengthPointer/4],n=a[t.channelCountPointer/4],o=a.subarray(a[t.statePointer/4]/4,a[t.statePointer/4]/4+2),u=[];for(let s=0;s<n;s++)u.push(i.subarray(a[a[t.channelDataPointer/4]/4+s]/4,a[a[t.channelDataPointer/4]/4+s]/4+r));return e.bufferLength=r,e.channelCount=n,e.states=o,e.channelData=u,e}push(t,e){const a=Atomics.load(this.states,this.States.READ),s=Atomics.load(this.states,this.States.WRITE);if(this._getAvailableWrite(a,s)<e)return!1;let i=s+e;if(this.bufferLength<i){i-=this.bufferLength;for(let e=0;e<this.channelCount;e++){const a=this.channelData[e].subarray(s),r=this.channelData[e].subarray(0,i);a.set(t[e].subarray(0,a.length)),r.set(t[e].subarray(a.length))}}else{for(let a=0;a<this.channelCount;a++)this.channelData[a].subarray(s,i).set(t[a].subarray(0,e));i===this.bufferLength&&(i=0)}return Atomics.store(this.states,this.States.WRITE,i),!0}pull(t,e){const a=Atomics.load(this.states,this.States.READ),s=Atomics.load(this.states,this.States.WRITE);if(this._getAvailableRead(a,s)<e)return!1;let i=a+e;if(this.bufferLength<i){i-=this.bufferLength;for(let e=0;e<this.channelCount;e++){const s=this.channelData[e].subarray(a),r=this.channelData[e].subarray(0,i);t[e].set(s),t[e].set(r,s.length)}}else{for(let e=0;e<this.channelCount;++e)t[e].set(this.channelData[e].subarray(a,i));i===this.bufferLength&&(i=0)}return Atomics.store(this.states,this.States.READ,i),!0}printAvailableReadAndWrite(){const t=Atomics.load(this.states,this.States.READ),e=Atomics.load(this.states,this.States.WRITE);console.log(this,{availableRead:this._getAvailableRead(t,e),availableWrite:this._getAvailableWrite(t,e)})}getAvailableSamples(){const t=Atomics.load(this.states,this.States.READ),e=Atomics.load(this.states,this.States.WRITE);return this._getAvailableRead(t,e)}isFrameAvailable(t){return this.getAvailableSamples()>=t}getBufferLength(){return this.bufferLength-1}_getAvailableWrite(t,e){return e>=t?this.bufferLength-e+t-1:t-e-1}_getAvailableRead(t,e){return e>=t?e-t:e+this.bufferLength-t}_reset(){for(let t=0;t<this.channelCount;t++)this.channelData[t].fill(0);Atomics.store(this.states,this.States.READ,0),Atomics.store(this.states,this.States.WRITE,0)}}const i=s},8663:(t,e,a)=>{t.exports=a.p+"11ff4f83a261dfb3.js"}}]);